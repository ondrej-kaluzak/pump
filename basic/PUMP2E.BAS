5 DEFDBL A-Z:DEF FNTX$(X)=RIGHT$(STR$(X),LEN(STR$(X))-1):DEF FNSD(X$,X)=ASC(MID$(X$,X,1))-48:DEF FNFC(X)=LOG(X)*1200/LOG(2)
8 DIM D$(4095):DIM Q(49),QX(47),QY(47),R(11):P(0)=1:P(1)=7:P(2)=2:P(3)=3:P(4)=5:C$= "ABDABEABFACDACEACFAFDAFECBDCBECBFEBDEBFECDCFDEFD":B$="203032404243"
10 FOR X=0 TO 11
15 R(X)=FNSD(B$,X+1):NEXT
20 INPUT "NUMERATOR";OX
30 IF OX<16 OR NOT OX=INT(OX) THEN 20
40 INPUT "DENOMINATOR";OY
50 IF OY<15 OR NOT OY=INT(OY) THEN 40
55 NX=OX:NY=OY:Q(1)=0:Q(2)=0:Q(3)=0:Q(4)=0
60 FOR X=4 TO 1 STEP -1
70 IF NOT NX/P(X)=INT(NX/P(X)) THEN 90
80 NX =NX/P(X):Q(X)=Q(X)+1:GOTO 70
90 IF NOT NY/P(X)=INT(NY/P(X)) THEN 110
100 NY =NY/P(X):Q(X)=Q(X)-1:GOTO 90
110 NEXT
120 IF NOT (NX=1 AND NY=1) THEN PRINT "HIGHER PRIMES USED, PLEASE REENTER":GOTO 20
125 OPEN "O",#1,"PUMPLIST.TXT":CC=FNFC(OX/OY)
130 FOR X=0 TO 14
140 FA=FNSD(C$,X*3+4)*2-34:FB=FNSD(C$,X*3+5)*2-34:FC=FNSD(C$,X*3+6)*2-34
150 SX(0)=R(FA):SY(0)=R(FA+1):SX(1)=R(FB):SY(1)=R(FB+1):SX(2)=R(FC):SY(2)=R(FC+1)
160 Z(2)=0:Z(3)=0:Z(4)=0
170 FOR Y=2 TO 4
175 TX=SX(Y-2):TY=SY(Y-2)
177 IF NOT TY=0 THEN 180
178 Z(Y)=Z(Y)+Q(TX):GOTO 190
180 IF TY=Y THEN 185
182 TZ=SY(TY-2):IF TX=Y THEN Z(TX)=Z(TX)+Q(TX):IF TZ=TY THEN Z(TY)=Z(TY)-Q(TX) ELSE Z(TY)=Z(TY)+Q(TX)
184 GOTO 190
185 TZ=SY(TX-2):Z(TY)=Z(TY)-Q(TY):IF TZ=TX THEN Z(TX)=Z(TX)-Q(TY) ELSE Z(TX)=Z(TX)+Q(TY)
190 NEXT
191 IF SY(2)=SX(1) AND NOT SY(1)=0 THEN Z(2)=Z(2)+Q(4)
192 IF SY(1)=SX(0) AND NOT SY(0)=0 THEN Z(4)=Z(4)+Q(2)
193 IF SX(2)=SX(1) AND NOT SY(2)=0 THEN Z(2)=Z(2)+Q(3)
194 IF SY(2)=SY(0) AND NOT SY(0)=0 THEN Z(3)=Z(3)+Q(4)
195 IF SX(2)=SX(0) AND NOT SY(2)=0 THEN Z(3)=Z(3)+Q(2)
196 IF SY(1)=SY(0) AND NOT SY(0)=0 THEN Z(4)=Z(4)+Q(3)
198 Q(X*3+5)=Z(2):Q(X*3+6)=Z(3):Q(X*3+7)=Z(4)
199 QX(X*3+3)=SX(0):QY(X*3+3)=SY(0):QX(X*3+4)=SX(1):QY(X*3+4)=SY(1):QX(X*3+5)=SX(2):QY(X*3+5)=SY(2)
200 NEXT
205 QX(0)=2:QX(1)=3:QX(2)=4
210 FOR X=0 TO 15
215 RX(1)=Q(1):RX(2)=Q(X*3+2):RX(3)=Q(X*3+3):RX(4)=Q(X*3+4):RS=ABS(RX(2))+ABS(RX(3))+ABS(RX(4))
220 PRINT #1,MID$(C$,X*3+1,3)+":":PRINT #1,"[";RX(1);RX(2);RX(3);STR$(RX(4))+"]"
230 FOR U=0 TO 2
240 IF RX(U+2)=0 THEN 260
245 IF RX(U+2)<0 THEN CD(U)=FNFC(P(QX(X*3+U))/P(QY(X*3+U)))+CC/RS ELSE CD(U)=FNFC(P(QX(X*3+U))/P(QY(X*3+U)))-CC/RS
247 CE!=CD(U)
250 PRINT #1,CE!
260 NEXT
263 IF RX(1)=0 THEN GOSUB 300
265 PRINT #1,""
270 NEXT
280 CLOSE:SYSTEM
300 XA=RX(3):YA=RX(4)
305 IF RX(3)<0 THEN YB=-CD(1) ELSE YB=CD(1)
310 IF RX(4)<0 THEN XB=-CD(2) ELSE XB=CD(2)
315 IF SGN(XA)=SGN(YA) THEN XA=-XA
320 ZA=XA+YA
330 IF ABS(YA)>ABS(XA) THEN ZC=YA:ZB=XA ELSE ZC=XA:ZB=YA
332 ZD=ZB-ZC
335 IF ZA>ZB THEN WA=ZB:WB=ZA ELSE WA=ZA:WB=ZB
340 IF NOT (ZB-1)/2=INT((ZB-1)/2) THEN S1=ABS(ZB)/2-1:S2=ABS(ZB)/2 ELSE S1=(ABS(ZB)-1)/2:S2=(ABS(ZB)-1)/2
345 IF ABS(WB)>ABS(WA) THEN GA=WA-S2:GB=WB+S1 ELSE GA=WA-S1:GB=WB+S2
347 GOTO 355
350 PRINT #1,"STARTING TRIAD:";WA;WB:PRINT #1,"NUMBER OF TONES:";ZD
352 PRINT #1,"GENERATOR RANGE:";GA;GB
355 IF ABS(ZD)<2 OR RX(2)=0 OR RX(3)=0 OR RX(4)=0 THEN 460
360 GS=0:PS=0:PRINT #1,"----------":PRINT #1,"! PUMPLIST.SCL"
370 PRINT #1,MID$(C$,X*3+1,3)+" COMMA PUMP OF"+STR$(OX)+"/"+FNTX$(OY)
380 PRINT #1,ABS(ZD):PRINT #1,"!"
390 FOR TD=1 TO ABS(ZD)
400 IF GS+YA>GB OR GS+YA<GA THEN GS=GS+XA:PS=PS+XB ELSE GS=GS+YA:PS=PS+YB
410 IF PS>0 THEN 420
415 PS=PS+CD(0):GOTO 410
420 IF NOT PS>CD(0) THEN 430
425 PS=PS-CD(0):GOTO 420
430 IF ABS(PS)<1D-11 THEN PS=PS+CD(0)
435 PT=INT(1/2+PS*1D+11)/1D+11
440 PRINT #1,PT;" | ";GS
450 NEXT
455 REM "Scale written."
460 RETURN

